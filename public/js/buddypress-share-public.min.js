($=>{let SELECTORS={shareButton:".bp-activity-share-dropdown-toggle a.dropdown-toggle",shareDropdown:".bp-activity-share-dropdown-toggle",shareModal:"#activity-share-modal",activityShareButton:".bp-secondary-action.bp-activity-share-button",copyButton:".bp-copy",popupOverlay:".bp-share-service-popup-overlay",serviceButtons:".service-buttons",postInSelect:"#post-in",reshareBtn:".bp-activity-reshare-btn"},ShareCache={groups:null,friends:null,loaded:!1,getShareOptions:function(forceReload=!1){return this.loaded&&!forceReload?Promise.resolve({groups:this.groups||[],friends:this.friends||[]}):new Promise((resolve,reject)=>{$.ajax({url:bp_activity_share_vars.ajax_url,method:"POST",data:{action:"bp_get_user_share_options",_ajax_nonce:bp_activity_share_vars.ajax_nonce},dataType:"json",success:response=>{response.success?(this.groups=response.data.groups||[],this.friends=response.data.friends||[],this.loaded=!0,resolve(response.data)):reject(new Error(response.data?.message||"Failed to load share options"))},error:()=>{reject(new Error("Network error while loading share options"))}})})},clear:function(){this.groups=null,this.friends=null,this.loaded=!1}},ActivityShare={init:function(){this.setupDropdowns(),this.setupModalHandling(),this.setupSocialSharing(),this.setupCopyLink(),this.setupReshareOptions(),this.setupDropdownPosition()},setupDropdowns:function(){$(document).on("click",SELECTORS.shareButton,this.handleDropdownToggle.bind(this)),$(document).on("click",SELECTORS.popupOverlay,this.closeDropdown.bind(this)),$("body").on("mouseup",this.handleOutsideClick.bind(this)),$(document).on("click",".bp-share-activity-share-to-wrapper .bp-share",this.handleShareButtonClick.bind(this))},handleDropdownToggle:function(e){e.preventDefault();e=$(e.currentTarget).closest(SELECTORS.shareDropdown);$("body").toggleClass("bp-share-popup-active");e.siblings(SELECTORS.serviceButtons).toggle(500);var $overlay=e.siblings(SELECTORS.popupOverlay);$overlay.length&&$overlay.toggle(),$(".bp-activity-more-options-wrap").toggleClass("bp-activity-share-popup-open"),e.siblings(".selected").removeClass("selected"),e.toggleClass("selected")},closeDropdown:function(){$(SELECTORS.popupOverlay).hide(),$("body").removeClass("bp-share-popup-active"),$(SELECTORS.serviceButtons).hide(),$(".bp-activity-more-options-wrap").removeClass("bp-activity-share-popup-open"),$(SELECTORS.shareDropdown).removeClass("selected")},handleOutsideClick:function(e){$(SELECTORS.shareDropdown+" *").is(e.target)||$(SELECTORS.shareDropdown).removeClass("selected")},handleShareButtonClick:function(e){$(e.currentTarget).hasClass("bp-copy")||$(SELECTORS.shareDropdown).removeClass("selected")},setupModalHandling:function(){this.initializeSelect2(),$(document).on("click",SELECTORS.activityShareButton,this.handleShareButtonOpen.bind(this)),$(document).on("click",".bp-activity-share-activity",this.submitShareActivity.bind(this)),$(document).on("click",".bp-activity-share-close, .activity-share-modal-close",this.closeModal.bind(this)),void 0!==$.fn.modal&&($(SELECTORS.shareModal).on("show.bs.modal shown.bs.modal",this.onModalShow.bind(this)),$(SELECTORS.shareModal).on("hide.bs.modal hidden.bs.modal",this.onModalHidden.bind(this))),this.setupModalBackdropHandling()},initializeSelect2:function(){void 0!==$.fn.select2&&($(document).on("shown.bs.modal",SELECTORS.shareModal,function(){var $select=$(SELECTORS.postInSelect);$select.hasClass("select2-hidden-accessible")&&$select.select2("destroy"),$select.select2({dropdownParent:$(SELECTORS.shareModal),placeholder:"Select where to share...",allowClear:!1,minimumResultsForSearch:10,width:"100%",escapeMarkup:function(markup){return markup}})}),$(document).ready(function(){setTimeout(function(){var $select=$(SELECTORS.postInSelect);$select.length&&!$select.hasClass("select2-hidden-accessible")&&$select.select2({dropdownParent:$(SELECTORS.shareModal),placeholder:"Select where to share...",allowClear:!1,minimumResultsForSearch:10,width:"100%"})},100)}))},setupModalBackdropHandling:function(){$(document).on("click",SELECTORS.shareModal,function(e){e.target===this&&$(this).modal("hide")}),$(document).on("keydown",function(e){27===e.keyCode&&((e=$(SELECTORS.shareModal)).hasClass("show")||e.hasClass("in"))&&ActivityShare.closeModal()})},onModalShow:function(){this.loadShareOptionsIfNeeded()},onModalHidden:function(){this.resetModal()},loadShareOptionsIfNeeded:function(){var $select=$(SELECTORS.postInSelect),hasGroupsOptgroup=0<$select.find("#bp-share-groups-options").length,hasFriendsOptgroup=0<$select.find("#bp-share-friends-options").length;(hasGroupsOptgroup||hasFriendsOptgroup)&&(hasGroupsOptgroup=0<$select.find("#bp-share-groups-options option").length,hasFriendsOptgroup=0<$select.find("#bp-share-friends-options option").length,hasGroupsOptgroup&&hasFriendsOptgroup||(this.bpShareShowLoading(),ShareCache.getShareOptions().then(this.bpShareLoadOptions.bind(this)).catch(this.handleLoadError.bind(this)).finally(this.bpShareHideLoading.bind(this))))},bpShareShowLoading:function(){var $select=$(SELECTORS.postInSelect);$select.prop("disabled",!0),$select.parent().addClass("loading")},bpShareHideLoading:function(){var $select=$(SELECTORS.postInSelect);$select.prop("disabled",!1),$select.parent().removeClass("loading")},bpShareLoadOptions:function(data){var $select=$(SELECTORS.postInSelect);if(data.groups&&0<data.groups.length){let $groupOptgroup=$select.find("#bp-share-groups-options");0<$groupOptgroup.length&&($groupOptgroup.empty(),data.groups.forEach(group=>{$groupOptgroup.append($("<option>").val(group.id).attr("data-type","group").text(group.name))}))}if(data.friends&&0<data.friends.length){let $friendOptgroup=$select.find("#bp-share-friends-options");0<$friendOptgroup.length&&($friendOptgroup.empty(),data.friends.forEach(friend=>{$friendOptgroup.append($("<option>").val(friend.id).attr("data-type","user").text(friend.display_name))}))}$select.hasClass("select2-hidden-accessible")&&($select.trigger("change"),$select.select2("destroy").select2({dropdownParent:$(SELECTORS.shareModal),placeholder:"Select where to share...",allowClear:!1,minimumResultsForSearch:10,width:"100%"}))},handleLoadError:function(error){let $errorMsg=$("<div>").addClass("bp-share-error-message").text("Unable to load sharing options. Please try again.");$(SELECTORS.shareModal).find(".modal-header").after($errorMsg),setTimeout(()=>{$errorMsg.fadeOut(()=>$errorMsg.remove())},5e3)},handleShareButtonOpen:function(e){e.preventDefault(),e.stopPropagation();let activityId="",activityHtml="";var reshareShareActivity=bp_activity_share_vars.reshare_share_activity,e=$(e.currentTarget);e.closest(".bp-generic-meta.action").hasClass("photos-meta")||e.closest(".bp-generic-meta.action").hasClass("videos-meta")||e.closest(".bp-generic-meta.action").hasClass("documents-meta")?(activityId=e.data("activity-id"),this.fetchActivityContent(activityId,reshareShareActivity)):(void 0!==e.data("post-id")&&""!==e.data("post-id")?activityId=e.data("post-id"):(activityId=e.data("activity-id"),activityHtml=$("#activity-"+activityId).html(),"child"===reshareShareActivity&&$("#activity-"+activityId+" .activity-reshare-item-container").each(function(){var idParts=$(this).attr("id").split("bp-reshare-activity-");activityId=idParts[1],activityHtml=$(this).html(),$(this).hasClass("post-reshare-item-container")?$("#bp-reshare-type").val("post_share"):$("#bp-reshare-type").val("activity_share")})),""!==activityHtml&&this.displayActivityInModal(activityId,activityHtml,reshareShareActivity)),$("#bp-reshare-activity-id").val(activityId),this.showModal()},showModal:function(){var $modal=$(SELECTORS.shareModal);void 0!==$.fn.modal?$modal.modal("show"):($modal.addClass("show").removeClass("fade"),$("body").addClass("modal-open"),$(".modal-backdrop").length||$("body").append('<div class="modal-backdrop fade show"></div>'))},fetchActivityContent:function(activityId,reshareShareActivity){$.ajax({url:bp_activity_share_vars.ajax_url,method:"POST",data:{action:"bp_share_get_activity_content",activity_id:activityId,_ajax_nonce:bp_activity_share_vars.ajax_nonce},dataType:"json",beforeSend:()=>{this.showActivityLoadingState()},success:response=>{response.success&&""!==response.data.contents?(response=$($.parseHTML(response.data.contents)).filter("#activity-"+activityId).html(),this.displayActivityInModal(activityId,response,reshareShareActivity)):this.showActivityLoadError()},error:()=>{this.showActivityLoadError()},complete:()=>{this.hideActivityLoadingState()}})},showActivityLoadingState:function(){$(SELECTORS.shareModal+" .modal-body #bp-activity-share-widget-box-status-header").html('<div class="bp-share-loading">Loading activity...</div>')},hideActivityLoadingState:function(){},showActivityLoadError:function(){$(SELECTORS.shareModal+" .modal-body #bp-activity-share-widget-box-status-header").html('<div class="bp-share-error">Failed to load activity content.</div>')},displayActivityInModal:function(activityId,activityHtml,reshareShareActivity){var activityUlClass=$("#activity-stream ul").attr("class")||"activity-list item-list bp-list",activityId=$("#activity-stream ul li#activity-"+activityId).attr("class")||"activity activity_update activity-item";let $container=$(SELECTORS.shareModal+" .modal-body #bp-activity-share-widget-box-status-header");$container.attr("class","").addClass(activityUlClass),$container.html('<div class="'+activityId+'">'+activityHtml+"</div>"),"parent"===reshareShareActivity&&$container.find(".activity-reshare-item-container").remove();[".activity-meta",".post-footer",".activity-comments",".entry-button-wraper",".bp-activity-post-footer"].forEach(selector=>{$container.find(selector).remove()})},submitShareActivity:function(e){e.preventDefault();e=$(SELECTORS.shareModal+" #bp-activity-share-text").val();let activityId=$(SELECTORS.shareModal+" #bp-reshare-activity-id").val();var activityUserId=$(SELECTORS.shareModal+" #bp-reshare-activity-user-id").val(),component=$(SELECTORS.shareModal+" #bp-reshare-activity-current-component").val(),activityIn=$(SELECTORS.shareModal+" #post-in").val(),type=$(SELECTORS.shareModal+" #bp-reshare-type").val(),activityInType=$(SELECTORS.shareModal+" #post-in option:selected").data("type");if(null==activityIn||""===activityIn)return $(".bp_activity_share_modal_error_message").show(),!1;this.bpShareButtonLoading(),$.ajax({url:bp_activity_share_vars.ajax_url,method:"POST",data:{action:"bp_activity_create_reshare_ajax",activity_content:e,activity_id:activityId,activity_user_id:activityUserId,component:component,activity_in:activityIn,activity_in_type:activityInType,type:type,_ajax_nonce:bp_activity_share_vars.ajax_nonce},dataType:"json",success:response=>{response.success?this.handleShareSuccess(activityId,response.data):this.handleShareError(response.data?.message||"Failed to share activity")},error:()=>{this.handleShareError("Network error occurred")},complete:()=>{this.bpShareButtonReset()}})},bpShareButtonLoading:function(){$(".bp-activity-share-activity").prop("disabled",!0).text("Sharing...")},bpShareButtonReset:function(){$(".bp-activity-share-activity").prop("disabled",!1).text("Post")},handleShareSuccess:function(activityId,data){this.closeModal();var $shareCount=$("#bp-activity-reshare-count-"+activityId),$shareCount=(data.share_count?$shareCount.text(data.share_count):(data=parseInt($shareCount.text())||0,$shareCount.text(data+1)),$("#bp-activity-share-"+activityId+" .share-count"));if(0<$shareCount.length){let currentCount=parseInt($shareCount.text())||0;$shareCount.text(currentCount+1)}this.showSuccessMessage("Activity shared successfully!")},handleShareError:function(message){this.showErrorMessage(message)},showSuccessMessage:function(message){let $message=$("<div>").addClass("bp-share-success-message notice notice-success").text(message);$("body").prepend($message),setTimeout(()=>{$message.fadeOut(()=>$message.remove())},3e3)},showErrorMessage:function(message){let $message=$("<div>").addClass("bp-share-error-message notice notice-error").text(message);$(SELECTORS.shareModal).find(".modal-body").prepend($message),setTimeout(()=>{$message.fadeOut(()=>$message.remove())},5e3)},closeModal:function(e){e&&(e.preventDefault(),e.stopPropagation());e=$(SELECTORS.shareModal);void 0!==$.fn.modal?e.modal("hide"):(e.removeClass("show").addClass("fade"),$("body").removeClass("modal-open"),$(".modal-backdrop").remove())},resetModal:function(){$("#bp-activity-share-text").val(""),$(".bp_activity_share_modal_error_message").hide(),$(".bp-share-error-message").remove();var $select=$(SELECTORS.postInSelect);$select.val("0"),$select.hasClass("select2-hidden-accessible")&&$select.trigger("change"),$("#bp-activity-share-widget-box-status-header").empty()},setupSocialSharing:function(){$(document).on("click",".bp-share.has-popup",e=>{"no-popup"!==$(e.currentTarget).attr("attr-display")&&(e.preventDefault(),this.openSharePopup($(e.currentTarget).attr("href")))})},openSharePopup:function(url){var leftBoundary=window.screenLeft||window.screenX||0,topBoundary=window.screenTop||window.screenY||0,leftBoundary=screen.width/2-350+leftBoundary,url=window.open(url,"share_popup","height=485,width=700,left="+leftBoundary+",top="+(screen.height/2-225+topBoundary)+",scrollbars=yes,resizable=yes");url&&url.focus()},setupCopyLink:function(){$(document).on("click",SELECTORS.copyButton,e=>{e.preventDefault(),this.copyToClipboard($(e.currentTarget))})},copyToClipboard:function($button){let copyText=$button.data("href"),$tooltip=$button.next();navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(copyText).then(()=>this.showCopySuccess($tooltip)).catch(()=>this.fallbackCopyToClipboard(copyText,$tooltip)):this.fallbackCopyToClipboard(copyText,$tooltip)},fallbackCopyToClipboard:function(text,$tooltip){text=$("<textarea>").val(text).css({position:"fixed",left:"-9999px",top:"-9999px"});$("body").append(text),text.select(),text[0].setSelectionRange(0,99999);try{document.execCommand("copy")?this.showCopySuccess($tooltip):this.showCopyError($tooltip)}catch(err){this.showCopyError($tooltip)}text.remove()},showCopySuccess:function($tooltip){$tooltip.removeClass("tooltip-hide").text("Link Copied!"),setTimeout(()=>{$tooltip.addClass("tooltip-hide")},2e3)},showCopyError:function($tooltip){$tooltip.removeClass("tooltip-hide").text("Copy failed"),setTimeout(()=>{$tooltip.addClass("tooltip-hide")},2e3)},setupReshareOptions:function(){$(document).on("click",SELECTORS.reshareBtn,e=>{e.preventDefault(),this.handleReshareOptionClick($(e.currentTarget))}),$("body").on("mouseup",this.handleReshareCleanup.bind(this)),$(".bp-activity-share-activity, .activity-share-modal-close").on("click",this.handleReshareCleanup.bind(this))},handleReshareOptionClick:function($button){let reshareOption=$button.data("reshare");var $button=$button.attr("data-title"),$select2=("my-profile"===reshareOption&&(reshareOption="0"),$(SELECTORS.postInSelect).val(reshareOption).trigger("change"),$(SELECTORS.postInSelect).next(".select2-container")),$select2=($select2.length&&$select2.find(".select2-selection__rendered").text($button),$button.toLowerCase().replace(/\s+/g,"-"));$(".activity-share-modal").addClass($select2).data("reshareOptionTextClass",$select2)},handleReshareCleanup:function(e){var $container=$(".activity-share-modal"),reshareOptionTextClass=$container.data("reshareOptionTextClass");$container.is(e.target)||0!==$container.has(e.target).length||$container.removeClass(reshareOptionTextClass)},setupDropdownPosition:function(){let scrollTimeout;$(window).on("scroll",()=>{scrollTimeout&&clearTimeout(scrollTimeout),scrollTimeout=setTimeout(this.toggleDropdownPosition,16)}),this.toggleDropdownPosition()},toggleDropdownPosition:function(){var windowScrollTop=$(window).scrollTop(),windowHeight=$(window).height(),windowScrollTop=$(document).height()-100<=windowScrollTop+windowHeight;$(".bp-activity-share-dropdown-menu").toggleClass("position-top",windowScrollTop)}};$(document).ready(function(){try{ActivityShare.init(),void 0!==$.fn.modal&&$(SELECTORS.shareModal).length&&$(SELECTORS.shareModal).modal({show:!1,backdrop:!0,keyboard:!0})}catch(error){}}),window.BPActivityShare=ActivityShare})(jQuery);