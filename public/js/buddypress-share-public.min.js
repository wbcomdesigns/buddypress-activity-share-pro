let{__,_x,_n,sprintf}=wp.i18n;($=>{let SELECTORS={shareButton:".bp-activity-share-dropdown-toggle a.dropdown-toggle",shareDropdown:".bp-activity-share-dropdown-toggle",shareModal:"#activity-share-modal",activityShareButton:".bp-secondary-action.bp-activity-share-button",copyButton:".bp-copy",popupOverlay:".bp-share-service-popup-overlay",serviceButtons:".service-buttons",postInSelect:"#post-in",reshareBtn:".bp-activity-reshare-btn"},ActivityShare={init:function(){this.setupDropdowns(),this.setupModalHandling(),this.setupSocialSharing(),this.setupCopyLink(),this.setupReshareOptions(),this.setupDropdownPosition(),this.setupReadMore()},setupDropdowns:function(){$(document).on("click",SELECTORS.shareButton,function(e){e.preventDefault(),$("body").addClass("bp-share-popup-active"),$(this).parent().parent().next(SELECTORS.serviceButtons).toggle(500);e=$(this).parent().parent().next().next(SELECTORS.popupOverlay),e.length&&e.show(),e=$(".bp-activity-more-options-wrap");0<e.length&&!e.hasClass("bp-activity-share-popup-open")&&e.addClass("bp-activity-share-popup-open")}),$(document).on("click",SELECTORS.popupOverlay,function(){$(this).hide(),$("body").removeClass("bp-share-popup-active"),$(SELECTORS.serviceButtons).hide();var optionsWrap=$(".bp-activity-more-options-wrap");0<optionsWrap.length&&optionsWrap.hasClass("bp-activity-share-popup-open")&&optionsWrap.removeClass("bp-activity-share-popup-open")}),$("body").on("mouseup",function(e){$(SELECTORS.shareDropdown+" *").is(e.target)||$(SELECTORS.shareDropdown).removeClass("selected")}),$(document).on("click",".bp-share-activity-share-to-wrapper .bp-share",function(){$(this).hasClass("bp-copy")||$(SELECTORS.shareDropdown).removeClass("selected")}),$(document).on("click",SELECTORS.shareButton,function(e){e.preventDefault();e=$(this).closest(SELECTORS.shareDropdown);e.siblings(".selected").removeClass("selected"),e.toggleClass("selected")})},setupModalHandling:function(){$(SELECTORS.postInSelect).select2({dropdownParent:$(SELECTORS.shareModal)}),$(document).on("click",SELECTORS.activityShareButton,function(e){e.preventDefault();let activityId="",activityHtml="";e=bp_activity_share_vars.reshare_share_activity;$(this).parents(".bp-generic-meta.action").hasClass("photos-meta")||$(this).parents(".bp-generic-meta.action").hasClass("videos-meta")||$(this).parents(".bp-generic-meta.action").hasClass("documents-meta")?(activityId=$(this).data("activity-id"),ActivityShare.fetchActivityContent(activityId,e)):(void 0!==$(this).data("post-id")&&""!==$(this).data("post-id")?activityId=$(this).data("post-id"):(activityId=$(this).data("activity-id"),activityHtml=$("#activity-"+activityId).html(),"child"===e&&$("#activity-"+activityId+" .activity-reshare-item-container").each(function(){var idParts=$(this).attr("id").split("bp-reshare-activity-");activityId=idParts[1],activityHtml=$(this).html(),$(this).hasClass("post-reshare-item-container")?$("#bp-reshare-type").val("post_share"):$("#bp-reshare-type").val("activity_share")})),""!==activityHtml&&ActivityShare.displayActivityInModal(activityId,activityHtml,e)),$(SELECTORS.shareModal).on("shown.bs.modal",function(){$(SELECTORS.shareModal).modal("show")}),$("#bp-reshare-activity-id").val(activityId)}),$(document).on("click",".bp-activity-share-activity",function(e){e.preventDefault(),ActivityShare.submitShareActivity()}),$(document).on("click",".bp-activity-share-close",function(){$(SELECTORS.shareModal).modal("hide")})},fetchActivityContent:function(activityId,reshareShareActivity){$.ajax({url:bp_activity_share_vars.ajax_url,method:"POST",data:{action:"bp_share_get_activity_content",activity_id:activityId,_ajax_nonce:bp_activity_share_vars.ajax_nonce},dataType:"json",success:function(response){response.success&&""!==response.data.contents&&(response=$($.parseHTML(response.data.contents)).filter("#activity-"+activityId).html(),ActivityShare.displayActivityInModal(activityId,response,reshareShareActivity))},error:function(){console.error(__("Failed to fetch activity content","buddypress-share"))}})},displayActivityInModal:function(activityId,activityHtml,reshareShareActivity){var activityUlClass=$("#activity-stream ul").attr("class")||"activity-list item-list bp-list",activityId=$("#activity-stream ul li#activity-"+activityId).attr("class")||"activity activity_update activity-item",$container=$(SELECTORS.shareModal+" .modal-body #bp-activity-share-widget-box-status-header");$container.attr("class","").addClass(activityUlClass),$container.html('<div class="'+activityId+'">'+activityHtml+"</div>"),"parent"===reshareShareActivity&&$container.find(".activity-reshare-item-container").remove(),$(SELECTORS.shareModal+" .modal-body .activity-meta, "+SELECTORS.shareModal+" .modal-body .post-footer, "+SELECTORS.shareModal+" .modal-body .activity-comments, "+SELECTORS.shareModal+" .modal-body .entry-button-wraper, "+SELECTORS.shareModal+" .modal-body .bp-activity-post-footer").remove()},submitShareActivity:function(){var activityContent=$(SELECTORS.shareModal+" #bp-activity-share-text").val();let activityId=$(SELECTORS.shareModal+" #bp-reshare-activity-id").val();var activityUserId=$(SELECTORS.shareModal+" #bp-reshare-activity-user-id").val(),component=$(SELECTORS.shareModal+" #bp-reshare-activity-current-component").val(),activityIn=$(SELECTORS.shareModal+" #post-in").val(),type=$(SELECTORS.shareModal+" #bp-reshare-type").val(),activityInType=$(SELECTORS.shareModal+" #post-in option:selected").data("type");if(null==activityIn)return $(".bp_activity_share_modal_error_message").show(),!1;$.ajax({url:bp_activity_share_vars.ajax_url,method:"POST",data:{action:"bp_activity_create_reshare_ajax",activity_content:activityContent,activity_id:activityId,activity_user_id:activityUserId,component:component,activity_in:activityIn,activity_in_type:activityInType,type:type,_ajax_nonce:bp_activity_share_vars.ajax_nonce},dataType:"json",success:function(response){var currentCount;response.success?($(SELECTORS.shareModal).modal("hide"),$(SELECTORS.shareModal+" #bp-activity-share-text").val(""),response=$("#bp-activity-reshare-count-"+activityId),currentCount=parseInt(response.text())||0,response.text(currentCount+1),0<(response=$("#bp-activity-share-"+activityId+" .share-count")).length&&response.text(currentCount+1)):console.error(__("Failed to share activity","buddypress-share"))},error:function(){console.error(__("AJAX request failed","buddypress-share"))}})},setupSocialSharing:function(){$(document).on("click",".bp-share.has-popup",function(e){"no-popup"!==$(this).attr("attr-display")&&(e.preventDefault(),ActivityShare.openSharePopup($(this).attr("href")))})},openSharePopup:function(url){var leftBoundary=window.screenLeft||window.screenX||0,topBoundary=window.screenTop||window.screenY||0,leftBoundary=screen.width/2-350+leftBoundary;window.open(url,"","height=485,width=700,left="+leftBoundary+",top="+(screen.height/2-225+topBoundary))},setupCopyLink:function(){$(document).on("click",SELECTORS.copyButton,function(e){e.preventDefault();e=$(this).data("href");let tooltip=$(this).next();var tempTextarea=$("<textarea>");tempTextarea.val(e),$("body").append(tempTextarea),tempTextarea.select();let message;try{var successful=document.execCommand("copy");message=successful?__("Copied!","buddypress-share"):__("Copy failed","buddypress-share")}catch(err){message=__("Unable to copy","buddypress-share"),console.error(message,err)}tempTextarea.remove(),tooltip.removeClass("tooltip-hide"),setTimeout(function(){tooltip.addClass("tooltip-hide")},1e3)})},setupReshareOptions:function(){$(document).on("click",SELECTORS.reshareBtn,function(e){e.preventDefault();let reshareOption=$(this).data("reshare");e=$(this).attr("data-title"),"my-profile"===reshareOption&&(reshareOption="0"),$(SELECTORS.postInSelect).val(reshareOption).trigger("change"),$(SELECTORS.postInSelect).next(".select2-container").find(".select2-selection__rendered").text(e),e=e.toLowerCase().replace(/\s+/g,"-");$(".activity-share-modal").addClass(e).data("reshareOptionTextClass",e)}),$("body").mouseup(function(e){var container=$(".activity-share-modal"),reshareOptionTextClass=container.data("reshareOptionTextClass");container.is(e.target)||0!==container.has(e.target).length||container.removeClass(reshareOptionTextClass)}),$(".bp-activity-share-activity, .activity-share-modal-close").on("click",function(e){e.preventDefault();var e=$(".activity-share-modal"),reshareOptionTextClass=e.data("reshareOptionTextClass");e.removeClass(reshareOptionTextClass)})},setupDropdownPosition:function(){function toggleDropdownPosition(){$(".bp-activity-share-dropdown-menu").each(function(){var $dropdown=$(this),windowScrollTop=$(window).scrollTop(),windowHeight=$(window).height(),documentHeight=$(document).height();$dropdown.toggleClass("position-top",documentHeight-100<=windowScrollTop+windowHeight)})}$(window).scroll(toggleDropdownPosition),toggleDropdownPosition()},setupReadMore:function(){$(document).on("click",".activity-reshare-item-container .activity-read-more a",function(event){event.preventDefault();var activityId=$(this).parents(".activity-reshare-item-container").data("bp-activity-id"),event=$(event.target);let content=event.closest("div"),readMore=event.closest("span");$(readMore).addClass("loading"),bp.Nouveau.ajax({action:"get_single_activity_content",id:activityId},"activity").done(function(response){$(readMore).removeClass("loading"),content.parent().find(".bp-feedback").length&&content.parent().find(".bp-feedback").remove(),!1===response.success?(content.after(response.data.feedback),content.parent().find(".bp-feedback").hide().fadeIn(300)):$(content).slideUp(300).html(response.data.contents).slideDown(300)})})}};$(document).ready(function(){ActivityShare.init()})})(jQuery);